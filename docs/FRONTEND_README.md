# NutriZen Frontend

## Stack

- **Framework:** Vite + React 18 + TypeScript
- **Routing:** React Router v6
- **State Management:** TanStack Query (React Query) + Zustand
- **UI:** shadcn/ui + Tailwind CSS
- **Backend:** Supabase (Postgres + Realtime + Edge Functions)
- **Build Tool:** Vite

---

## Environment Variables

Create a `.env.local` file (never commit this!):

```bash
# Supabase Public Configuration (SAFE for client)
VITE_SUPABASE_URL=https://pghdaozgxkbtsxwydemd.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Application
VITE_APP_NAME=NutriZen
VITE_APP_URL=https://nutrizen.app

# Locale
VITE_LOCALE=fr-FR
VITE_TIMEZONE=Europe/Paris
```

âš ï¸ **NEVER** expose service role key on the client! It must only be used in Edge Functions.

---

## Local Development

### Prerequisites
- Node.js 18+ or Bun
- Supabase account (for backend)

### Setup

```bash
# Install dependencies
npm install
# or
bun install

# Copy environment template
cp .env.example .env.local
# Edit .env.local with your values

# Run development server
npm run dev
# or
bun dev

# Open browser at http://localhost:8080
```

### Development Commands

```bash
# Development server with hot reload
npm run dev

# Type checking
npm run typecheck

# Build for production
npm run build

# Preview production build
npm run preview

# Lint code
npm run lint
```

---

## Project Structure

```
src/
â”œâ”€â”€ actions/              # Server action wrappers for Edge Functions
â”‚   â”œâ”€â”€ generateMenu.ts   # Menu generation
â”‚   â””â”€â”€ initUser.ts       # User initialization
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ common/           # Reusable UI components
â”‚   â”‚   â”œâ”€â”€ EmptyState.tsx
â”‚   â”‚   â”œâ”€â”€ ErrorState.tsx
â”‚   â”‚   â”œâ”€â”€ InfoBanner.tsx
â”‚   â”‚   â””â”€â”€ Spinner.tsx
â”‚   â”œâ”€â”€ kpi/             # KPI dashboard cards
â”‚   â”‚   â”œâ”€â”€ CreditsCard.tsx
â”‚   â”‚   â”œâ”€â”€ MentalLoadCard.tsx
â”‚   â”‚   â”œâ”€â”€ ReferencesCard.tsx
â”‚   â”‚   â”œâ”€â”€ StreakCard.tsx
â”‚   â”‚   â””â”€â”€ TimeSavedCard.tsx
â”‚   â”œâ”€â”€ menu/            # Menu-related components
â”‚   â”‚   â”œâ”€â”€ MenuCard.tsx      # Individual meal card
â”‚   â”‚   â””â”€â”€ WeekGrid.tsx      # 7-day grid layout
â”‚   â””â”€â”€ ui/              # shadcn/ui base components
â”œâ”€â”€ hooks/               # Custom React hooks
â”‚   â”œâ”€â”€ useDashboardStats.ts  # TanStack Query hook for stats
â”‚   â”œâ”€â”€ useGamification.ts    # TanStack Query hook for gamification
â”‚   â”œâ”€â”€ useWeeklyMenu.ts      # TanStack Query hook for menu + realtime
â”‚   â””â”€â”€ use-toast.ts          # Toast notifications
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ queryClient.ts   # TanStack Query configuration
â”‚   â””â”€â”€ realtime.ts      # Supabase realtime utilities
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ Dashboard.tsx     # Main dashboard
â”‚   â”‚   â”œâ”€â”€ Profile.tsx       # Preferences/settings
â”‚   â”‚   â””â”€â”€ RecipeDetail.tsx  # Recipe detail page
â”‚   â””â”€â”€ auth/            # Auth pages (login, signup, etc.)
â”œâ”€â”€ providers/
â”‚   â””â”€â”€ AppProviders.tsx # Global providers wrapper
â””â”€â”€ App.tsx             # Root component with routing
```

---

## Key Features

### 1. Zero Defaults

All KPI cards display **0** when data is missing or null:

```typescript
// âœ… CORRECT - Always coalesce to 0
const minutes = stats?.temps_gagne ?? 0;
const mentalLoad = stats?.charge_mentale_pct ?? 0;
const streak = gamification?.streak_days ?? 0;

// âŒ WRONG - Could show NaN or undefined
const minutes = stats?.temps_gagne;
```

### 2. Menu Persistence

- Menus are **always** loaded from `user_weekly_menus` table
- Never rely solely on component state
- TanStack Query provides caching + background refresh
- Navigating away and back shows the **same menu**

### 3. Realtime Updates

Dashboard subscribes to Supabase Realtime:

```typescript
// Automatic refetch when menu changes
supabase
  .channel('user-menus')
  .on('postgres_changes', {
    event: '*',
    schema: 'public',
    table: 'user_weekly_menus',
    filter: `user_id=eq.${userId}`
  }, () => {
    queryClient.invalidateQueries(['weeklyMenu']);
  })
  .subscribe();
```

### 4. Image Handling

- **Public URLs:** Direct from Supabase Storage
- **Signed URLs:** Generated by backend (7-day validity)
- **Fallback:** `/img/hero-default.png` if missing
- **Error handling:** `onError` handler replaces broken images

```typescript
<img 
  src={imageUrl || '/img/hero-default.png'}
  alt={title}
  onError={(e) => {
    e.currentTarget.src = '/img/hero-default.png';
  }}
/>
```

### 5. Recipe Detail Routing

- Route: `/app/recipes/:id`
- Fetches recipe from `public.recipes` by ID
- Never 404s for valid recipe IDs
- Includes "Back to Dashboard" link

### 6. Loading & Error States

- **Loading:** Skeleton loaders for cards
- **Empty:** CTA to generate first menu
- **Error:** Retry button + user-friendly message
- **Success:** Toast notifications

---

## TanStack Query Setup

### Configuration

```typescript
// lib/queryClient.ts
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000,      // 5 minutes
      cacheTime: 10 * 60 * 1000,     // 10 minutes
      refetchOnWindowFocus: true,
      retry: 1,
    },
  },
});
```

### Custom Hooks

```typescript
// hooks/useWeeklyMenu.ts
export function useWeeklyMenu(userId: string) {
  return useQuery({
    queryKey: ['weeklyMenu', userId],
    queryFn: () => fetchWeeklyMenu(userId),
    enabled: !!userId,
    staleTime: 5 * 60 * 1000,
  });
}
```

### Prefetching

```typescript
// Prefetch data before navigation
queryClient.prefetchQuery(['recipe', recipeId], () => 
  fetchRecipe(recipeId)
);
```

---

## Internationalization (i18n)

Currently hardcoded to **French (fr-FR)** with Europe/Paris timezone.

### Common Labels

```typescript
const labels = {
  // Dashboard
  hello: (name: string) => `Salut, ${name} ! ðŸ‘‹`,
  regenerateWeek: "RÃ©gÃ©nÃ©rer la semaine",
  generateWeek: "GÃ©nÃ©rer ma semaine",
  
  // KPIs
  timeSaved: "Temps gagnÃ©",
  mentalLoad: "Charge mentale",
  streak: "SÃ©rie en cours",
  credits: "CrÃ©dits Zen",
  references: "RÃ©fÃ©rences",
  
  // Menu
  viewRecipe: "Voir la recette",
  validate: "Valider",
  swap: "Swap",
  
  // Days
  days: ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"],
};
```

To change labels, edit the relevant component files.

---

## Accessibility

### Guidelines Implemented

- âœ… Semantic HTML (`<header>`, `<main>`, `<section>`, `<article>`)
- âœ… ARIA labels on all interactive elements
- âœ… Keyboard navigation support
- âœ… Focus outlines visible
- âœ… Alt text on all images
- âœ… Color contrast meets WCAG AA
- âœ… Screen reader friendly

### Testing

```bash
# Run accessibility audit with axe-core
npm run a11y

# Manual testing
# - Tab through entire page
# - Use only keyboard (no mouse)
# - Test with screen reader (VoiceOver/NVDA)
```

---

## Performance

### Optimizations

1. **Code Splitting:** React.lazy for heavy components
2. **Image Optimization:** Responsive images, lazy loading
3. **Memoization:** React.memo, useMemo, useCallback
4. **Query Caching:** TanStack Query reduces API calls
5. **Bundle Size:** Tree-shaking, dynamic imports

### Metrics

```bash
# Analyze bundle size
npm run build
npm run preview

# Lighthouse audit
npm run lighthouse
```

### Performance Budget

- First Contentful Paint: < 1.5s
- Largest Contentful Paint: < 2.5s
- Total Blocking Time: < 200ms
- Cumulative Layout Shift: < 0.1

---

## Testing

### Unit Tests (Vitest)

```bash
npm run test
npm run test:ui    # Visual UI for tests
```

### E2E Tests (Playwright)

```bash
npm run test:e2e          # Run all tests
npm run test:e2e:ui       # Interactive mode
```

Test scenarios:
- âœ… Onboarding flow
- âœ… Menu generation
- âœ… Menu persistence
- âœ… Recipe detail navigation
- âœ… Preferences save triggers menu regen
- âœ… Zero defaults on dashboard
- âœ… Realtime updates

---

## Deployment

### Build

```bash
npm run build
# Output: dist/
```

### Environment Variables (Production)

Set these in your hosting platform (Vercel, Netlify, etc.):

```bash
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
VITE_APP_URL=https://your-domain.com
```

### Hosting Platforms

**Vercel (Recommended)**
```bash
# Install Vercel CLI
npm i -g vercel

# Deploy
vercel

# Production
vercel --prod
```

**Netlify**
```bash
# Build command: npm run build
# Publish directory: dist
# Redirects: Create _redirects file for SPA routing
```

---

## Troubleshooting

### Images Not Loading

1. Check `image_url` in payload from backend
2. Verify CORS settings in Supabase Storage
3. Check browser console for 403/404 errors
4. Ensure fallback image exists: `/public/img/hero-default.png`

### Menu Not Persisting

1. Check `user_weekly_menus` table has data (Supabase dashboard)
2. Verify RLS policies allow user to read own menus
3. Check TanStack Query devtools for cache state
4. Look for errors in console related to Supabase client

### Realtime Not Working

1. Verify realtime is enabled in Supabase dashboard
2. Check filter: `filter: \`user_id=eq.${userId}\``
3. Ensure channel subscription is active
4. Look for WebSocket errors in network tab

### Zero Defaults Not Showing

1. Check coalescing: `stats?.value ?? 0` (not `|| 0`)
2. Verify database columns have `DEFAULT 0`
3. Check `user_dashboard_stats` table has row for user
4. Test with: `SELECT * FROM user_dashboard_stats WHERE user_id = 'xxx'`

---

## Support

- **Documentation:** [docs.lovable.dev](https://docs.lovable.dev)
- **Supabase Docs:** [supabase.com/docs](https://supabase.com/docs)
- **TanStack Query:** [tanstack.com/query](https://tanstack.com/query/latest)

---

## Contributing

### Code Style

- Use TypeScript strict mode
- Follow ESLint rules
- Use Prettier for formatting
- Write tests for new features
- Update documentation

### Git Workflow

```bash
git checkout -b feature/your-feature
git commit -m "feat: add your feature"
git push origin feature/your-feature
# Create PR
```

### Commit Convention

- `feat:` New feature
- `fix:` Bug fix
- `docs:` Documentation update
- `style:` Code style changes
- `refactor:` Code refactoring
- `test:` Test updates
- `chore:` Build/config changes

---

## License

Proprietary - All rights reserved

---

## Credits

Built with â¤ï¸ using Lovable
